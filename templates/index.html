<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAM 语义分割标注工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Inter', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        .main-container {
            background: var(--background-color);
            min-height: 100vh;
            border-radius: 0;
        }

        .header-section {
            background: linear-gradient(135deg, var(--primary-color) 0%, #3b82f6 100%);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
        }

        .header-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-subtitle {
            opacity: 0.9;
            font-size: 0.95rem;
            margin: 0.25rem 0 0 0;
        }

        .control-panel {
            background: var(--card-background);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .control-panel:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-1px);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        .canvas-container {
            position: relative;
            margin: 0 auto;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            background: #f8fafc;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
        }

        .canvas-container:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        #imageCanvas, #maskCanvas, #interactionCanvas {
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 10px;
        }

        #interactionCanvas {
            cursor: crosshair;
        }

        .class-item {
            cursor: pointer;
            margin: 0.25rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .class-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .class-item:hover::before {
            opacity: 1;
        }

        .class-item.active {
            border-color: #ffffff;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.3);
            transform: scale(1.02);
        }

        .point-marker {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .marker-positive {
            background: linear-gradient(135deg, #10b981, #059669);
            border: 3px solid #ffffff;
        }

        .marker-negative {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border: 3px solid #ffffff;
        }

        .status-bar {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .tool-group {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .btn {
            border-radius: 8px;
            font-weight: 500;
            padding: 0.6rem 1.2rem;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s ease, height 0.3s ease;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #3b82f6);
            border: none;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1d4ed8, var(--primary-color));
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #059669);
            border: none;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #047857, var(--success-color));
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
            border: none;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #b91c1c, var(--danger-color));
            transform: translateY(-1px);
        }

        .btn-outline-secondary {
            color: var(--secondary-color);
            border-color: var(--border-color);
            background: var(--card-background);
        }

        .btn-outline-secondary:hover {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
            color: white;
        }

        .btn-toggle {
            color: var(--text-secondary);
            background: var(--card-background);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .btn-toggle:hover {
            color: var(--text-primary);
            background: #f1f5f9;
            border-color: var(--primary-color);
        }

        .btn-toggle.active,
        .btn-check:checked + .btn-toggle {
            color: white;
            background: linear-gradient(135deg, var(--primary-color), #3b82f6);
            border-color: var(--primary-color);
            box-shadow: var(--shadow-sm);
        }

        .btn-outline-success {
            color: var(--success-color);
            border-color: var(--success-color);
        }

        .btn-outline-success:hover,
        .btn-check:checked + .btn-outline-success {
            background: var(--success-color);
            border-color: var(--success-color);
        }

        .btn-outline-danger {
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .btn-outline-danger:hover,
        .btn-check:checked + .btn-outline-danger {
            background: var(--danger-color);
            border-color: var(--danger-color);
        }

        .form-control {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            transition: all 0.2s ease;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .input-group {
            box-shadow: var(--shadow-sm);
            border-radius: 8px;
            overflow: hidden;
        }

        .result-preview {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            transition: all 0.2s ease;
        }

        .result-preview:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        .nav-tabs {
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 8px 8px 0 0;
            color: var(--text-secondary);
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            transition: all 0.2s ease;
        }

        .nav-tabs .nav-link.active {
            background: var(--primary-color);
            color: white;
            border-bottom: 2px solid var(--primary-color);
        }

        .list-group-item {
            border: 1px solid var(--border-color);
            border-radius: 8px !important;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
            background: var(--card-background);
        }

        .list-group-item:hover {
            background: #f8fafc;
            transform: translateX(2px);
        }

        .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), #3b82f6);
            color: white;
            border-radius: 12px 12px 0 0;
            padding: 1.5rem;
        }

        .modal-title {
            font-weight: 600;
        }

        .card {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .card-header {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-bottom: 1px solid var(--border-color);
            font-weight: 500;
            padding: 1rem 1.25rem;
        }

        .alert-success {
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            border: 1px solid #a7f3d0;
            color: #065f46;
            border-radius: 8px;
        }

        .loading-spinner {
            display: none;
            margin: 0 auto;
            width: 2rem;
            height: 2rem;
        }

        /* 动画效果 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .control-panel {
            animation: fadeInUp 0.5s ease-out;
        }

        .control-panel:nth-child(2) { animation-delay: 0.1s; }
        .control-panel:nth-child(3) { animation-delay: 0.2s; }
        .control-panel:nth-child(4) { animation-delay: 0.3s; }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .header-title {
                font-size: 1.5rem;
            }
            
            .control-panel {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .canvas-container {
                margin: 0 -15px;
                border-radius: 0;
            }
        }

        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- 头部区域 -->
        <div class="header-section">
            <div class="container-fluid">
                <div class="row align-items-center">
                    <div class="col">
                        <h1 class="header-title">
                            <i class="fas fa-magic"></i>
                            SAM 语义分割标注工具
                        </h1>
                        <p class="header-subtitle">
                            <i class="fas fa-robot me-1"></i>
                            基于Segment Anything Model的智能图像分割标注平台
                        </p>
                    </div>
                    <div class="col-auto">
                        <div class="d-flex align-items-center gap-3">
                            <span class="badge bg-success px-3 py-2">
                                <i class="fas fa-circle-check me-1"></i>
                                系统就绪
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container-fluid px-4">
            <div class="row">
                <!-- 左侧控制面板 -->
                <div class="col-lg-3 col-md-4">
                    <!-- 文件上传 -->
                    <div class="control-panel">
                        <h5 class="section-title">
                            <i class="fas fa-cloud-upload-alt text-primary"></i>
                            图像上传
                        </h5>
                        <div class="mb-3">
                            <input class="form-control" type="file" id="imageUpload" accept="image/*">
                        </div>
                        <button id="uploadBtn" class="btn btn-primary w-100">
                            <i class="fas fa-upload me-2"></i>
                            上传图像
                        </button>
                    </div>
                    
                    <!-- 工具选择 -->
                    <div class="control-panel">
                        <h5 class="section-title">
                            <i class="fas fa-tools text-primary"></i>
                            标注工具
                        </h5>
                        <div class="tool-group">
                            <div class="btn-group w-100 mb-3" role="group">
                                <input type="radio" class="btn-check" name="toolType" id="toolPoint" value="point" checked>
                                <label class="btn btn-toggle" for="toolPoint">
                                    <i class="fas fa-crosshairs me-1"></i>
                                    点标注
                                </label>
                                
                                <input type="radio" class="btn-check" name="toolType" id="toolBox" value="box">
                                <label class="btn btn-toggle" for="toolBox">
                                    <i class="fas fa-vector-square me-1"></i>
                                    框选
                                </label>
                            </div>
                            
                            <div id="pointToolOptions">
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="pointType" id="toolPositive" value="positive" checked>
                                    <label class="btn btn-outline-success" for="toolPositive">
                                        <i class="fas fa-plus me-1"></i>
                                        正点
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="pointType" id="toolNegative" value="negative">
                                    <label class="btn btn-outline-danger" for="toolNegative">
                                        <i class="fas fa-minus me-1"></i>
                                        负点
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 类别管理 -->
                    <div class="control-panel">
                        <h5 class="section-title">
                            <i class="fas fa-tags text-primary"></i>
                            标注类别
                        </h5>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="newClassName" placeholder="新类别名称">
                            <input type="color" class="form-control form-control-color" id="newClassColor" value="#ff0000">
                            <button class="btn btn-outline-secondary" type="button" id="addClassBtn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="classList" class="d-flex flex-wrap"></div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="control-panel">
                        <h5 class="section-title">
                            <i class="fas fa-cogs text-primary"></i>
                            操作面板
                        </h5>
                        <div class="row g-2">
                            <div class="col-6">
                                <button id="predictBtn" class="btn btn-primary w-100" disabled>
                                    <i class="fas fa-brain me-1"></i>
                                    生成蒙版
                                </button>
                            </div>
                            <div class="col-6">
                                <button id="saveBtn" class="btn btn-success w-100" disabled>
                                    <i class="fas fa-save me-1"></i>
                                    保存结果
                                </button>
                            </div>
                            <div class="col-4">
                                <button id="clearPointsBtn" class="btn btn-outline-secondary w-100" disabled>
                                    <i class="fas fa-eraser me-1"></i>
                                    清除点
                                </button>
                            </div>
                            <div class="col-4">
                                <button id="clearBoxBtn" class="btn btn-outline-secondary w-100" disabled>
                                    <i class="fas fa-square me-1"></i>
                                    清除框
                                </button>
                            </div>
                            <div class="col-4">
                                <button id="clearMaskBtn" class="btn btn-outline-secondary w-100" disabled>
                                    <i class="fas fa-mask me-1"></i>
                                    清除蒙版
                                </button>
                            </div>
                            <div class="col-12 mt-2">
                                <button id="resetBtn" class="btn btn-danger w-100" disabled>
                                    <i class="fas fa-undo me-1"></i>
                                    重置所有
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 状态栏 -->
                    <div class="status-bar" id="statusBar">
                        <i class="fas fa-info-circle me-2"></i>
                        准备就绪
                    </div>
                </div>
                
                <!-- 中间画布区域 -->
                <div class="col-lg-6 col-md-8">
                    <div class="canvas-container" id="canvasContainer">
                        <canvas id="imageCanvas"></canvas>
                        <canvas id="maskCanvas"></canvas>
                        <canvas id="interactionCanvas"></canvas>
                        <div id="markersContainer"></div>
                    </div>
                </div>
                
                <!-- 右侧预览面板 -->
                <div class="col-lg-3 col-md-12 mt-md-3 mt-lg-0">
                    <div class="control-panel">
                        <h5 class="section-title">
                            <i class="fas fa-eye text-primary"></i>
                            预览区域
                        </h5>
                        <div class="nav nav-tabs" id="resultTabs">
                            <button class="nav-link active" id="combined-tab" data-bs-toggle="tab" data-bs-target="#combined" type="button">
                                <i class="fas fa-layer-group me-1"></i>
                                所有蒙版
                            </button>
                        </div>
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="combined">
                                <img id="combinedMaskPreview" class="result-preview" />
                            </div>
                        </div>
                    </div>
                    
                    <div class="control-panel">
                        <h5 class="section-title">
                            <i class="fas fa-check-circle text-success"></i>
                            已完成标注
                        </h5>
                        <ul class="list-group list-group-flush" id="completedMasks">
                            <li class="list-group-item text-center text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                暂无已完成标注
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 结果模态框 -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-chart-line me-2"></i>
                        标注结果
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-image me-1"></i>
                                    语义分割图
                                </div>
                                <div class="card-body p-2">
                                    <img id="semanticResult" class="img-fluid rounded" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-palette me-1"></i>
                                    彩色分割图
                                </div>
                                <div class="card-body p-2">
                                    <img id="coloredResult" class="img-fluid rounded" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-layer-group me-1"></i>
                                    叠加结果
                                </div>
                                <div class="card-body p-2">
                                    <img id="overlayResult" class="img-fluid rounded" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-success mt-3">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>保存成功！</strong> 可以在results文件夹中找到更多格式的导出文件。
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JS库 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ================ 初始化变量和工具 ================
            
            // 应用状态
            const appState = {
                imageLoaded: false,
                currentTool: 'point', // 'point' 或 'box'
                pointType: 'positive', // 'positive' 或 'negative'
                currentClass: { id: '1', name: '默认', color: '#ff0000' },
                classes: [{ id: '1', name: '默认', color: '#ff0000' }],
                completedMasks: {},
                scale: 1,
                imageWidth: 0,
                imageHeight: 0
            };
            
            // 点标注相关
            const pointsState = {
                points: [],
                labels: []
            };
            
            // 框选相关
            const boxState = {
                isDrawing: false,
                startX: 0,
                startY: 0,
                currentBox: null,
                activeBox: null,
                isDragging: false,
                isDraggingHandle: false,
                dragHandleType: '',
                dragStartX: 0,
                dragStartY: 0,
                offsetX: 0,
                offsetY: 0,
                boxes: [] // 支持多框
            };
            
            // DOM元素
            const elements = {
                // 容器
                canvasContainer: document.getElementById('canvasContainer'),
                markersContainer: document.getElementById('markersContainer'),
                
                // 画布
                imageCanvas: document.getElementById('imageCanvas'),
                maskCanvas: document.getElementById('maskCanvas'),
                interactionCanvas: document.getElementById('interactionCanvas'),
                
                // 工具和控制
                pointToolOptions: document.getElementById('pointToolOptions'),
                statusBar: document.getElementById('statusBar'),
                
                // 按钮
                uploadBtn: document.getElementById('uploadBtn'),
                predictBtn: document.getElementById('predictBtn'),
                clearPointsBtn: document.getElementById('clearPointsBtn'),
                clearBoxBtn: document.getElementById('clearBoxBtn'),
                clearMaskBtn: document.getElementById('clearMaskBtn'),
                saveBtn: document.getElementById('saveBtn'),
                resetBtn: document.getElementById('resetBtn'),
                addClassBtn: document.getElementById('addClassBtn'),
                
                // 输入
                imageUpload: document.getElementById('imageUpload'),
                newClassName: document.getElementById('newClassName'),
                newClassColor: document.getElementById('newClassColor'),
                
                // 预览
                combinedMaskPreview: document.getElementById('combinedMaskPreview'),
                completedMasksList: document.getElementById('completedMasks')
            };
            
            // 上下文
            const ctx = {
                image: elements.imageCanvas.getContext('2d'),
                mask: elements.maskCanvas.getContext('2d'),
                interaction: elements.interactionCanvas.getContext('2d')
            };
            
            // 结果模态框
            const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
            const resultElements = {
                semantic: document.getElementById('semanticResult'),
                colored: document.getElementById('coloredResult'),
                overlay: document.getElementById('overlayResult')
            };
            
            // ================ 工具函数 ================
            
            // 调整画布尺寸
            function resizeCanvas() {
                const containerWidth = elements.canvasContainer.clientWidth;
                
                if (appState.imageLoaded && appState.imageWidth > 0 && appState.imageHeight > 0) {
                    appState.scale = containerWidth / appState.imageWidth;
                    
                    // 保持宽高比
                    const scaledHeight = appState.imageHeight * appState.scale;
                    
                    // 设置容器高度
                    elements.canvasContainer.style.height = `${scaledHeight}px`;
                    
                    // 设置所有画布尺寸
                    [elements.imageCanvas, elements.maskCanvas, elements.interactionCanvas].forEach(canvas => {
                        canvas.width = containerWidth;
                        canvas.height = scaledHeight;
                    });
                    
                    // 重绘
                    drawImage();
                }
            }
            
            // 在画布上绘制图像
            function drawImage() {
                if (appState.imageLoaded && currentImage) {
                    ctx.image.clearRect(0, 0, elements.imageCanvas.width, elements.imageCanvas.height);
                    ctx.image.drawImage(currentImage, 0, 0, elements.imageCanvas.width, elements.imageCanvas.height);
                }
            }
            
            // 获取对比色（文字颜色）
            function getContrastColor(hexColor) {
                const color = hexColor.replace('#', '');
                const r = parseInt(color.substr(0, 2), 16);
                const g = parseInt(color.substr(2, 2), 16);
                const b = parseInt(color.substr(4, 2), 16);
                const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                return brightness > 128 ? '#000000' : '#ffffff';
            }
            
            // 清除交互画布
            function clearInteractionCanvas() {
                ctx.interaction.clearRect(0, 0, elements.interactionCanvas.width, elements.interactionCanvas.height);
            }

            // 清除蒙版画布
            function clearMask() {
                ctx.mask.clearRect(0, 0, elements.maskCanvas.width, elements.maskCanvas.height);
            }

            // 更新状态栏
            function updateStatus(message, type = 'info') {
                elements.statusBar.textContent = message;
                
                elements.statusBar.className = 'status-bar';
                if (type === 'warning') {
                    elements.statusBar.style.backgroundColor = '#fff3cd';
                    elements.statusBar.style.color = '#856404';
                } else if (type === 'error') {
                    elements.statusBar.style.backgroundColor = '#f8d7da';
                    elements.statusBar.style.color = '#721c24';
                } else {
                    elements.statusBar.style.backgroundColor = '#e9ecef';
                    elements.statusBar.style.color = '#212529';
                }
            }
            
            // 启用工具按钮
            function enableTools() {
                elements.predictBtn.disabled = false;
                elements.clearPointsBtn.disabled = false;
                elements.clearBoxBtn.disabled = false;
                elements.clearMaskBtn.disabled = false;
                elements.saveBtn.disabled = false;
                elements.resetBtn.disabled = false;
            }
            
            // 禁用工具按钮
            function disableTools() {
                elements.predictBtn.disabled = true;
                elements.clearPointsBtn.disabled = true;
                elements.clearBoxBtn.disabled = true;
                elements.clearMaskBtn.disabled = true;
                elements.saveBtn.disabled = true;
                elements.resetBtn.disabled = true;
            }
            
            // ================ 类别管理 ================
            
            // 更新类别列表
            function updateClassList() {
                const classList = document.getElementById('classList');
                classList.innerHTML = '';
                
                appState.classes.forEach(cls => {
                    const classItem = document.createElement('div');
                    classItem.className = `class-item ${cls.id === appState.currentClass.id ? 'active' : ''}`;
                    classItem.style.backgroundColor = cls.color;
                    classItem.style.color = getContrastColor(cls.color);
                    classItem.textContent = cls.name;
                    classItem.dataset.id = cls.id;
                    
                    classItem.addEventListener('click', function() {
                        appState.currentClass = cls;
                        updateClassList();
                        updateStatus(`已选择类别: ${cls.name}`);
                    });
                    
                    classList.appendChild(classItem);
                });
            }
            
            // ================ 点标注功能 ================
            
            // 添加点标记
            function addPointMarker(x, y, label) {
                const marker = document.createElement('div');
                marker.className = `point-marker marker-${label === 1 ? 'positive' : 'negative'}`;
                marker.style.left = `${x}px`;
                marker.style.top = `${y}px`;
                elements.markersContainer.appendChild(marker);
            }
            
            // 清除所有点
            function clearPoints() {
                pointsState.points = [];
                pointsState.labels = [];
                elements.markersContainer.innerHTML = '';
                updateStatus('已清除所有标注点');
            }
            
            // ================ 框选功能 ================
            
            // 绘制框的句柄
            function drawBoxHandles(x, y, width, height) {
                const handlePositions = [
                    { x: x, y: y },                 // 左上
                    { x: x + width, y: y },         // 右上
                    { x: x, y: y + height },        // 左下
                    { x: x + width, y: y + height } // 右下
                ];
                
                ctx.interaction.setLineDash([]);
                ctx.interaction.fillStyle = '#fff';
                ctx.interaction.strokeStyle = '#3498db';
                ctx.interaction.lineWidth = 2;
                
                handlePositions.forEach(pos => {
                    ctx.interaction.beginPath();
                    ctx.interaction.arc(pos.x, pos.y, 5, 0, Math.PI * 2);
                    ctx.interaction.fill();
                    ctx.interaction.stroke();
                });
            }
            
            // 绘制所有框
            function drawAllBoxes() {
                clearInteractionCanvas();
                boxState.boxes.forEach((box, idx) => {
                    drawBox(box.x, box.y, box.width, box.height, box === boxState.activeBox);
                });
            }

            // 绘制框选
            function drawBox(x, y, width, height, isActive = false) {
                // 不再清除画布，交由drawAllBoxes统一管理
                ctx.interaction.save();
                ctx.interaction.strokeStyle = isActive ? '#e67e22' : '#3498db';
                ctx.interaction.lineWidth = 2;
                ctx.interaction.setLineDash([6, 3]);
                ctx.interaction.strokeRect(x, y, width, height);

                ctx.interaction.fillStyle = isActive ? 'rgba(230, 126, 34, 0.2)' : 'rgba(52, 152, 219, 0.2)';
                ctx.interaction.fillRect(x, y, width, height);

                drawBoxHandles(x, y, width, height);
                ctx.interaction.restore();
            }
            
            // 保存当前框选
            function saveCurrentBox() {
                if (!boxState.isDrawing || !boxState.startX) return;

                const currentX = boxState.currentX || boxState.startX;
                const currentY = boxState.currentY || boxState.startY;

                const left = Math.min(boxState.startX, currentX);
                const top = Math.min(boxState.startY, currentY);
                const width = Math.abs(currentX - boxState.startX);
                const height = Math.abs(currentY - boxState.startY);

                // 检查最小尺寸
                if (width < 10 || height < 10) return;

                // 转换为原始图像坐标
                const originalLeft = left / appState.scale;
                const originalTop = top / appState.scale;
                const originalWidth = width / appState.scale;
                const originalHeight = height / appState.scale;

                // 新建框对象
                const newBox = {
                    x: left,
                    y: top,
                    width: width,
                    height: height,
                    originalX: originalLeft,
                    originalY: originalTop,
                    originalWidth: originalWidth,
                    originalHeight: originalHeight
                };

                boxState.boxes.push(newBox);
                boxState.activeBox = newBox;
                drawAllBoxes();

                updateStatus(`已创建框选: ${Math.round(originalLeft)},${Math.round(originalTop)} - ${Math.round(originalWidth)}x${Math.round(originalHeight)}`);
            }
            
            // 清除所有框
            function clearBox() {
                clearInteractionCanvas();
                boxState.activeBox = null;
                boxState.boxes = [];
                updateStatus('已清除所有框选');
            }
            
            // ================ 生成和管理蒙版 ================
            
            // 更新蒙版预览
            function updateMaskPreview(maskBase64, classId) {
                const maskImg = new Image();
                maskImg.onload = function() {
                    // 清除画布
                    ctx.mask.clearRect(0, 0, elements.maskCanvas.width, elements.maskCanvas.height);
                    
                    // 创建离屏canvas
                    const offCanvas = document.createElement('canvas');
                    offCanvas.width = elements.maskCanvas.width;
                    offCanvas.height = elements.maskCanvas.height;
                    const offCtx = offCanvas.getContext('2d');
                    
                    // 绘制mask图像到离屏canvas
                    offCtx.drawImage(maskImg, 0, 0, elements.maskCanvas.width, elements.maskCanvas.height);
                    
                    // 获取像素数据
                    const imgData = offCtx.getImageData(0, 0, offCanvas.width, offCanvas.height);
                    const data = imgData.data;
                    
                    // 获取类别颜色
                    const classColor = appState.classes.find(c => c.id === classId)?.color || '#ff0000';
                    // 解析颜色
                    const rgb = [
                        parseInt(classColor.substr(1,2),16),
                        parseInt(classColor.substr(3,2),16),
                        parseInt(classColor.substr(5,2),16)
                    ];
                    
                    // 替换mask区域颜色
                    for (let i = 0; i < data.length; i += 4) {
                        // mask为白色(255,255,255)时，alpha>0
                        if (data[i+3] > 0) {
                            data[i] = rgb[0];
                            data[i+1] = rgb[1];
                            data[i+2] = rgb[2];
                            data[i+3] = 128; // 半透明
                        } else {
                            data[i+3] = 0; // 完全透明
                        }
                    }
                    offCtx.putImageData(imgData, 0, 0);
                    
                    // 绘制到主canvas
                    ctx.mask.clearRect(0, 0, elements.maskCanvas.width, elements.maskCanvas.height);
                    ctx.mask.drawImage(offCanvas, 0, 0);
                };
                maskImg.src = `data:image/png;base64,${maskBase64}`;
            }
            
            // 更新组合蒙版
            function updateCombinedMask() {
                axios.get('/get_combined_mask')
                    .then(response => {
                        const data = response.data;
                        elements.combinedMaskPreview.src = `data:image/png;base64,${data.combined_mask}`;
                    })
                    .catch(error => {
                        console.error(error);
                        updateStatus('获取组合蒙版失败: ' + (error.response?.data?.error || error.message), 'error');
                    });
            }
            
            // 更新已完成蒙版列表
            function updateCompletedMasksList() {
                elements.completedMasksList.innerHTML = '';
                
                if (Object.keys(appState.completedMasks).length === 0) {
                    const emptyItem = document.createElement('li');
                    emptyItem.className = 'list-group-item text-center';
                    emptyItem.textContent = '暂无已完成标注';
                    elements.completedMasksList.appendChild(emptyItem);
                    return;
                }
                
                for (const classId in appState.completedMasks) {
                    const maskData = appState.completedMasks[classId];
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    
                    const classLabel = document.createElement('span');
                    classLabel.textContent = maskData.class.name;
                    classLabel.style.backgroundColor = maskData.class.color;
                    classLabel.style.color = getContrastColor(maskData.class.color);
                    classLabel.style.padding = '3px 8px';
                    classLabel.style.borderRadius = '3px';
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-sm btn-outline-danger';
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.title = '删除此蒙版';
                    deleteBtn.addEventListener('click', function() {
                        delete appState.completedMasks[classId];
                        updateCompletedMasksList();
                        updateCombinedMask();
                    });
                    
                    listItem.appendChild(classLabel);
                    listItem.appendChild(deleteBtn);
                    elements.completedMasksList.appendChild(listItem);
                }
            }
            
            // ================ 事件处理 ================
            
            // 工具类型切换
            document.querySelectorAll('input[name="toolType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const previousTool = appState.currentTool;
                    appState.currentTool = this.value;
                    
                    if (this.value === 'point') {
                        elements.pointToolOptions.style.display = 'block';
                        updateStatus('已选择点标注工具');
                        
                        // 切换到点标注工具时清除框选
                        if (previousTool === 'box') {
                            clearBox();
                        }
                    } else if (this.value === 'box') {
                        elements.pointToolOptions.style.display = 'none';
                        updateStatus('已选择框选工具');
                        
                        // 切换到框选工具时清除点标注
                        if (previousTool === 'point') {
                            clearPoints();
                        }
                    }
                });
            });
            
            // 点类型切换
            document.querySelectorAll('input[name="pointType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    appState.pointType = this.value;
                    updateStatus(`已选择${this.value === 'positive' ? '正点' : '负点'}工具`);
                });
            });
            
            // 添加新类别
            elements.addClassBtn.addEventListener('click', function() {
                const name = elements.newClassName.value.trim();
                if (name === '') {
                    updateStatus('请输入类别名称', 'warning');
                    return;
                }
                
                const id = (appState.classes.length + 1).toString();
                const color = elements.newClassColor.value;
                
                appState.classes.push({ id, name, color });
                updateClassList();
                elements.newClassName.value = '';
                
                // 添加新类别后自动清除当前标注
                clearAllAnnotations();
                
                updateStatus(`已添加类别: ${name}，并清除当前标注`);
            });
            
            // 上传图像
            elements.uploadBtn.addEventListener('click', function() {
                if (!elements.imageUpload.files[0]) {
                    updateStatus('请先选择图像文件', 'warning');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', elements.imageUpload.files[0]);
                
                updateStatus('正在上传图像...');
                
                axios.post('/upload', formData)
                    .then(response => {
                        const data = response.data;
                        appState.imageWidth = data.width;
                        appState.imageHeight = data.height;
                        
                        // 加载图像
                        currentImage = new Image();
                        currentImage.onload = function() {
                            appState.imageLoaded = true;
                            resizeCanvas();
                            enableTools();
                            updateStatus('图像上传成功，可以开始标注');
                        };
                        currentImage.src = `/uploads/${data.filename}`;
                    })
                    .catch(error => {
                        console.error(error);
                        updateStatus('图像上传失败: ' + (error.response?.data?.error || error.message), 'error');
                    });
            });
            
            // 清除点
            elements.clearPointsBtn.addEventListener('click', clearPoints);
            
            // 清除框
            elements.clearBoxBtn.addEventListener('click', clearBox);
            
            // 清除蒙版
            elements.clearMaskBtn.addEventListener('click', function() {
                clearMask();
                updateStatus('已清除当前蒙版');
            });
            
            // 重置所有
            elements.resetBtn.addEventListener('click', function() {
                if (confirm('确定要重置所有标注？这将清除所有标注点和蒙版')) {
                    clearAllAnnotations();
                    elements.combinedMaskPreview.src = '';
                    appState.completedMasks = {};
                    updateCompletedMasksList();
                    
                    axios.post('/clear')
                        .then(() => {
                            updateStatus('已重置所有标注');
                        })
                        .catch(error => {
                            console.error(error);
                            updateStatus('重置失败: ' + (error.response?.data?.error || error.message), 'error');
                        });
                }
            });
            
            // 预测蒙版
            elements.predictBtn.addEventListener('click', function() {
                // 检查是否有框选或点
                const hasBoxes = boxState.boxes.length > 0;
                const hasPoints = pointsState.points.length > 0;
                
                if (!hasBoxes && !hasPoints) {
                    updateStatus('请先添加框选或至少一个标注点', 'warning');
                    return;
                }
                
                updateStatus('正在生成蒙版...');
                
                // 准备请求数据
                let requestData = {
                    classId: appState.currentClass.id
                };
                
                if (hasPoints) {
                    // 使用点模式
                    requestData.points = pointsState.points;
                    requestData.labels = pointsState.labels;
                    requestData.mode = 'points';
                } else if (hasBoxes) {
                    // 支持多框
                    requestData.boxes = boxState.boxes.map(box => [
                        box.originalX,
                        box.originalY,
                        box.originalX + box.originalWidth,
                        box.originalY + box.originalHeight
                    ]);
                    requestData.mode = 'boxes';
                }
                
                axios.post('/predict', requestData)
                .then(response => {
                    const data = response.data;
                    updateMaskPreview(data.mask, data.class_id);
                    updateStatus(`蒙版生成成功 (得分: ${data.score.toFixed(3)})`);
                    
                    // 记录已完成的蒙版
                    appState.completedMasks[data.class_id] = {
                        mask: data.mask,
                        class: appState.classes.find(c => c.id === data.class_id)
                    };
                    
                    updateCompletedMasksList();
                    
                    // 更新组合蒙版
                    updateCombinedMask();
                })
                .catch(error => {
                    console.error(error);
                    updateStatus('蒙版生成失败: ' + (error.response?.data?.error || error.message), 'error');
                });
            });
            
            // 保存结果
            elements.saveBtn.addEventListener('click', function() {
                if (Object.keys(appState.completedMasks).length === 0) {
                    updateStatus('没有可保存的蒙版', 'warning');
                    return;
                }
                
                updateStatus('正在保存结果...');
                
                axios.post('/save_result', {
                    exportType: 'semantic'
                })
                .then(response => {
                    const data = response.data;
                    
                    // 显示结果预览
                    resultElements.semantic.src = `/results/${data.result_folder}/${data.files.semantic}`;
                    resultElements.colored.src = `/results/${data.result_folder}/${data.files.colored}`;
                    resultElements.overlay.src = `/results/${data.result_folder}/${data.files.overlay}`;
                    
                    // 显示模态框
                    resultModal.show();
                    
                    updateStatus('结果保存成功');
                })
                .catch(error => {
                    console.error(error);
                    updateStatus('结果保存失败: ' + (error.response?.data?.error || error.message), 'error');
                });
            });
            
            // 交互画布事件
            elements.interactionCanvas.addEventListener('mousedown', function(e) {
                if (!appState.imageLoaded) return;
                
                const rect = elements.interactionCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const originalX = x / appState.scale;
                const originalY = y / appState.scale;
                
                if (appState.currentTool === 'point') {
                    // 点标注
                    const label = appState.pointType === 'positive' ? 1 : 0;
                    
                    pointsState.points.push([originalX, originalY]);
                    pointsState.labels.push(label);
                    
                    // 可视化点
                    addPointMarker(x, y, label);
                    
                    updateStatus(`已添加${label === 1 ? '正' : '负'}点 (${Math.round(originalX)}, ${Math.round(originalY)})`);
                }
                else if (appState.currentTool === 'box') {
                    // 检查是否点击了某个框或句柄
                    let found = false;
                    for (let i = boxState.boxes.length - 1; i >= 0; i--) {
                        const box = boxState.boxes[i];
                        const handleSize = 10;
                        // 句柄
                        if (Math.abs(x - box.x) <= handleSize && Math.abs(y - box.y) <= handleSize) {
                            boxState.activeBox = box;
                            boxState.isDraggingHandle = true;
                            boxState.dragHandleType = 'tl';
                            found = true;
                            break;
                        } else if (Math.abs(x - (box.x + box.width)) <= handleSize && Math.abs(y - box.y) <= handleSize) {
                            boxState.activeBox = box;
                            boxState.isDraggingHandle = true;
                            boxState.dragHandleType = 'tr';
                            found = true;
                            break;
                        } else if (Math.abs(x - box.x) <= handleSize && Math.abs(y - (box.y + box.height)) <= handleSize) {
                            boxState.activeBox = box;
                            boxState.isDraggingHandle = true;
                            boxState.dragHandleType = 'bl';
                            found = true;
                            break;
                        } else if (Math.abs(x - (box.x + box.width)) <= handleSize && Math.abs(y - (box.y + box.height)) <= handleSize) {
                            boxState.activeBox = box;
                            boxState.isDraggingHandle = true;
                            boxState.dragHandleType = 'br';
                            found = true;
                            break;
                        }
                        // 框体
                        else if (x >= box.x && x <= box.x + box.width && y >= box.y && y <= box.y + box.height) {
                            boxState.activeBox = box;
                            boxState.isDragging = true;
                            boxState.offsetX = x - box.x;
                            boxState.offsetY = y - box.y;
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        boxState.activeBox = null;
                        boxState.isDrawing = true;
                        boxState.startX = x;
                        boxState.startY = y;
                    }
                    boxState.dragStartX = x;
                    boxState.dragStartY = y;
                    drawAllBoxes();
                }
            });
            
            elements.interactionCanvas.addEventListener('mousemove', function(e) {
                if (!appState.imageLoaded) return;
                
                const rect = elements.interactionCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                if (appState.currentTool === 'box') {
                    if (boxState.isDrawing) {
                        // 绘制正在创建的框
                        const width = x - boxState.startX;
                        const height = y - boxState.startY;
                        
                        // 支持从任何方向绘制
                        const drawX = width < 0 ? x : boxState.startX;
                        const drawY = height < 0 ? y : boxState.startY;
                        const drawWidth = Math.abs(width);
                        const drawHeight = Math.abs(height);
                        drawAllBoxes();
                        drawBox(drawX, drawY, drawWidth, drawHeight, true);
                        boxState.currentX = x;
                        boxState.currentY = y;
                    }
                    else if (boxState.isDragging && boxState.activeBox) {
                        // 移动整个框
                        const box = boxState.activeBox;
                        const newX = x - boxState.offsetX;
                        const newY = y - boxState.offsetY;
                        const maxX = elements.interactionCanvas.width - box.width;
                        const maxY = elements.interactionCanvas.height - box.height;
                        box.x = Math.max(0, Math.min(newX, maxX));
                        box.y = Math.max(0, Math.min(newY, maxY));
                        box.originalX = box.x / appState.scale;
                        box.originalY = box.y / appState.scale;
                        drawAllBoxes();
                    }
                    else if (boxState.isDraggingHandle && boxState.activeBox) {
                        const box = boxState.activeBox;
                        if (boxState.dragHandleType === 'tl') {
                            // 左上角
                            const newWidth = box.x + box.width - x;
                            const newHeight = box.y + box.height - y;
                            
                            if (newWidth > 10 && newHeight > 10) {
                                box.x = x;
                                box.y = y;
                                box.width = newWidth;
                                box.height = newHeight;
                            }
                        }
                        else if (boxState.dragHandleType === 'tr') {
                            // 右上角
                            const newWidth = x - box.x;
                            const newHeight = box.y + box.height - y;
                            
                            if (newWidth > 10 && newHeight > 10) {
                                box.y = y;
                                box.width = newWidth;
                                box.height = newHeight;
                            }
                        }
                        else if (boxState.dragHandleType === 'bl') {
                            // 左下角
                            const newWidth = box.x + box.width - x;
                            const newHeight = y - box.y;
                            
                            if (newWidth > 10 && newHeight > 10) {
                                box.x = x;
                                box.width = newWidth;
                                box.height = newHeight;
                            }
                        }
                        else if (boxState.dragHandleType === 'br') {
                            // 右下角
                            const newWidth = x - box.x;
                            const newHeight = y - box.y;
                            
                            if (newWidth > 10 && newHeight > 10) {
                                box.width = newWidth;
                                box.height = newHeight;
                            }
                        }
                        
                        // 更新原始尺寸
                        box.originalWidth = box.width / appState.scale;
                        box.originalHeight = box.height / appState.scale;
                        drawAllBoxes();
                    }
                }
            });
            
            elements.interactionCanvas.addEventListener('mouseup', function() {
                if (appState.currentTool === 'box') {
                    if (boxState.isDrawing) {
                        saveCurrentBox();
                        boxState.isDrawing = false;
                        boxState.currentX = null;
                        boxState.currentY = null;
                    }
                    boxState.isDragging = false;
                    boxState.isDraggingHandle = false;
                    drawAllBoxes();
                }
            });
            
            // 监听窗口大小变化
            window.addEventListener('resize', resizeCanvas);
            
            // ================ 初始化 ================
            
            updateClassList();
            
            // 初始化提示框
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>
</body>
</html>